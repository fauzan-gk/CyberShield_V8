# MalwareBazaar Integration - Debugging Guide

## How to View Debug Output

When you run the application, the malware hash loading process will be logged to the **Debug Output** window:

### Steps to View Debug Output:
1. Run your application in Visual Studio
2. Go to **Debug** ? **Windows** ? **Output** (or press `Ctrl + Alt + O`)
3. Select **Debug** from the dropdown
4. You'll see detailed logs like:

```
[Loader] Fetching malware hashes from MalwareBazaar API...
[MB API] POST to https://mb-api.abuse.ch/api/v1/ with params: query=get_family, family=emotet, limit=20
[MB API] Response status: OK
[MB API] Response length: 2048 bytes
[MB API] Query status: ok
[MB API] Data is array with 5 elements
[Loader] ? emotet: 5 samples
[Loader] API fetch complete: 8 succeeded, 7 failed, 47 total hashes
[Loader] ? Cached 47 malware hashes
? Successfully loaded 47 malware hashes from MalwareBazaar
```

---

## What Each Log Message Means

### ? Success Indicators
- `[Loader] ? Loaded X hashes from cache` - Using cached hashes (fast)
- `[MB API] Response status: OK` - API is reachable
- `[Loader] ? family: N samples` - Successfully fetched samples for that family
- `[Loader] ? Cached X malware hashes` - Successfully saved to cache

### ? Problem Indicators
- `[MB API] Network error` - Can't connect to API
- `[MB API] Request timeout` - API is too slow
- `[Loader] ? family: no results` - API returned no results for that family
- `[Loader] ? No hashes fetched from API, using hardcoded fallback signatures` - Fallback hashes being used

---

## If Hashes Aren't Loading

### Check Your Network
- Ensure you have internet connectivity
- Check if MalwareBazaar API is accessible:
  ```
  https://bazaar.abuse.ch/api/
  ```

### Check the Debug Output
Look for specific error messages and follow this flowchart:

```
Is there network error?
?? YES ? Check internet connection & firewall
?? NO ? Is there API response?
        ?? YES ? Is query_status == "ok"?
        ?       ?? YES ? Parser error (check JSON)
        ?       ?? NO ? API returned no data
        ?? NO ? API is unreachable (timeout/403)
```

### Manual Testing
1. Add this code to `Form1.cs` in a button click handler:
```csharp
private async void TestMalwareBazaarAPI()
{
    var client = new MalwareBazaarClient();
    var result = await client.GetByFamilyAsync("emotet", limit: 5);
    
    System.Diagnostics.Debug.WriteLine($"Test result: {result.Success}");
    System.Diagnostics.Debug.WriteLine($"Samples: {result.Samples.Count}");
    System.Diagnostics.Debug.WriteLine($"Error: {result.Error}");
}
```

---

## Fallback Signatures (Always Available)

If the API fails, these 10 malware signatures are always available:

| Malware | Type | SHA256 |
|---------|------|--------|
| WannaCry | Ransomware | `ed01ebfbc9eb5bbea545af4...` |
| Emotet | Trojan | `6c5360d41bd0dd4fa4380e7...` |
| TrickBot | Trojan | `c37e23f8fa0b06c1e1cd7e0...` |
| Zeus | Trojan | `52a0d02e6b2bfdc10f24fe7...` |
| Petya | Ransomware | `2b9a8ab19c09e7b89eb5e6f...` |
| Conficker | Worm | `3c6cb8d3ee710e17e82180d...` |
| Mirai | Botnet | `f7d408de2bec4e9e0a6b4d...` |
| Dridex | Trojan | `4f8c3a7d5b9e2f6a1c8b7d...` |
| Locky | Ransomware | `a1b2c3d4e5f6a1b2c3d4e5...` |
| BadRabbit | Ransomware | `b1c8d9e0f1a2b3c4d5e6f7...` |

---

## Cache Information

- **Location**: `%AppData%\CyberShield\Cache\malware_hashes_cache.txt`
- **Validity**: 24 hours
- **Auto-refresh**: Next time app starts (if cache is expired)
- **Clear manually**: Delete the cache file

---

## Common Issues & Solutions

### Issue: "No hashes fetched from MalwareBazaar"
**Cause**: API is unavailable or blocked
**Solution**: 
- Check internet connection
- Try accessing https://bazaar.abuse.ch directly
- Clear cache file and restart app
- Fallback signatures will be used automatically

### Issue: API timeout
**Cause**: Network is slow or API is overloaded
**Solution**:
- Wait a few moments and restart
- API timeout is set to 30 seconds (change in `MalwareBazaarClient.cs` if needed)

### Issue: Always using fallback signatures
**Cause**: Cache is disabled or API is completely blocked
**Solution**:
- Check firewall settings
- Check antivirus blocking API calls
- Verify network connectivity with: `ping bazaar.abuse.ch`

---

## Performance Notes

- **First run**: ~5-10 seconds (fetches from API)
- **Subsequent runs**: <1 second (uses cached hashes)
- **Cache refresh**: Happens automatically after 24 hours
- **Scan performance**: Not affected - hashes are loaded once at startup

---

## Code Locations

- **API Client**: `MalwareBazaarClient.cs` (lines 1-250)
- **Hash Loader**: `MalwareHashLoader.cs` (lines 1-200)
- **Integration**: `Form1.cs` InitializeVirusDatabase() method (lines 72-92)

