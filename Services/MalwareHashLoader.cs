using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Text.Json;
using System.Threading.Tasks;

namespace CyberShield_V3.Services
{
    public class MalwareHashLoader
    {
        private readonly MalwareBazaarClient _bazaarClient;
        private readonly string _cacheFilePath;

        public MalwareHashLoader(string apiKey)
        {
            _bazaarClient = new MalwareBazaarClient(apiKey);

            // USE A ROBUST PATH (MyDocuments is often safer than AppData for testing)
            string docPath = Environment.GetFolderPath(Environment.SpecialFolder.MyDocuments);
            string folder = Path.Combine(docPath, "CyberShield_DB");

            // Ensure folder exists
            if (!Directory.Exists(folder))
            {
                Directory.CreateDirectory(folder);
            }

            _cacheFilePath = Path.Combine(folder, "virus_db.json");
            System.Diagnostics.Debug.WriteLine($"[Loader] Database Path: {_cacheFilePath}");
        }

        public async Task<Dictionary<string, string>> LoadHashesAsync()
        {
            // 1. Try Load
            var hashes = LoadFromDisk();
            System.Diagnostics.Debug.WriteLine($"[Loader] Loaded {hashes.Count} signatures from local cache.");

            // 2. Try Download
            try
            {
                System.Diagnostics.Debug.WriteLine("[Loader] Downloading latest 100 threats...");
                var result = await _bazaarClient.GetRecentSamplesAsync(100);

                if (result.Success && result.Samples != null)
                {
                    int newCount = 0;
                    foreach (var sample in result.Samples)
                    {
                        if (!string.IsNullOrEmpty(sample.Sha256Hash))
                        {
                            string key = sample.Sha256Hash.ToLower();
                            if (!hashes.ContainsKey(key))
                            {
                                hashes[key] = sample.MalwareFamily;
                                newCount++;
                            }
                        }
                    }
                    System.Diagnostics.Debug.WriteLine($"[Loader] Downloaded {newCount} new threats.");

                    // 3. Force Save
                    SaveToDisk(hashes);
                }
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"[Loader] Download failed: {ex.Message}");
            }

            return hashes;
        }

        private Dictionary<string, string> LoadFromDisk()
        {
            if (!File.Exists(_cacheFilePath)) return new Dictionary<string, string>();

            try
            {
                string json = File.ReadAllText(_cacheFilePath);
                var data = JsonSerializer.Deserialize<Dictionary<string, string>>(json);
                return data ?? new Dictionary<string, string>();
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"[Loader] Corrupt DB, starting fresh: {ex.Message}");
                return new Dictionary<string, string>();
            }
        }

        private void SaveToDisk(Dictionary<string, string> hashes)
        {
            try
            {
                // Write with indentation so you can read it in Notepad
                var options = new JsonSerializerOptions { WriteIndented = true };
                string json = JsonSerializer.Serialize(hashes, options);
                File.WriteAllText(_cacheFilePath, json);

                System.Diagnostics.Debug.WriteLine($"[Loader] SAVED {hashes.Count} signatures to disk successfully.");
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"[Loader] CRITICAL SAVE ERROR: {ex.Message}");
            }
        }
    }
}